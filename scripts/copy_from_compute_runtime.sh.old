#!/bin/bash
set -e

# Copy relevant files from intel-compute-runtime to third_party

REPO="$(dirname ${BASH_SOURCE[0]})/../"
THIRD_PARTY="$REPO/src/third_party/"
SRC=$"$1"

if [ -z "$1" ] || ( ! [ -d "$SRC" ] )
then
	echo "Usage: $0 <compute-runtime-repo root> [--diff]"
	exit 1
fi

DIFF_MODE=0
CP_CMD="cp -v"
DIFF_CMD="diff --color=auto -u"

CMD="$CP_CMD"

if [ "$2" == "--diff" ]
then
	DIFF_MODE=1
	CMD="$DIFF_CMD"
fi


# Devices
$CMD "$SRC/shared/source/dll/devices/devices_base.inl" "$THIRD_PARTY/devices_base.inl"
$CMD "$SRC/shared/source/dll/devices/devices_additional.inl" "$THIRD_PARTY/devices_additional.inl"

if [ $DIFF_MODE -gt 0 ]
then
	$DIFF_CMD "$SRC/shared/source/dll/devices/devices.inl" "$THIRD_PARTY" || true
else
	$CP_CMD "$SRC/shared/source/dll/devices/devices.inl" "$THIRD_PARTY"
	sed -i "s:shared/source/dll/devices/:third_party/:g" "$THIRD_PARTY/devices.inl"
fi


# Device hwinfos
for GEN in gen9
do
	for FILE in "$SRC/shared/source/$GEN/hw_info"*
	do
		FILENAME="$(basename $FILE)"

		if [ $DIFF_MODE -gt 0 ]
		then
			$DIFF_CMD "$FILE" "$THIRD_PARTY/hw_info/$GEN/$FILENAME" || true
		else
			$CP_CMD "$FILE" "$THIRD_PARTY/hw_info/$GEN/$FILENAME"
			sed -i "s:shared/source/helpers/:third_party/helpers/:g" "$THIRD_PARTY/hw_info/$GEN/$FILENAME"
			sed -i "s:shared/source/$GEN/:third_party/hw_info/$GEN/:g" "$THIRD_PARTY/hw_info/$GEN/$FILENAME"
		fi
	done
done

# helpers
for FILE in \
	"$SRC/shared/source/helpers/hw_info.h" \
	"$SRC/shared/source/helpers/hw_info.cpp" \
	"$SRC/shared/source/helpers/hw_info_extended.cpp"
do
	FILENAME="$(basename $FILE)"

	if [ $DIFF_MODE -gt 0 ]
	then
		$DIFF_CMD "$FILE" "$THIRD_PARTY/helpers/$FILENAME" || true
	else
		$CP_CMD "$FILE" "$THIRD_PARTY/helpers/$FILENAME"
		sed -i "s:shared/source/helpers/:third_party/helpers/:g" "$THIRD_PARTY/helpers/$FILENAME"
	fi
done
